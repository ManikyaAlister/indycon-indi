---
title: "Group Level Analyses"
author: "Manikya Alister"
format: 
  html:
    code-fold: true
    code-summary: "Show the code"
editor: visual
---

```{r}
#| include = FALSE
library(here)
library(tidyverse)
library(brms)
```

```{r}
load(here("data/derived/model_comparison.Rdata"))
load(here("data/clean/all_data_clean.Rdata"))
data <- all_data[[1]] %>%
    mutate(update = post_adjusted - pre_adjusted) 

d_independence <- data %>% 
  filter(consensus != "contested")

d_consensus_only <- data %>% 
  filter(consensus != "dependent")
```

# What are the average belief updates for each claim type?

### Independent v Dependent consensus

```{r}
mean_updates <- d_independence %>%
  group_by(claim_type, consensus) %>%
  summarise(mean_update = mean(update),
    se_update = sd(update) / sqrt(n())
)

mean_updates %>% 
  ggplot(aes(x = claim_type, y = mean_update, fill = consensus)) + 
  geom_col(position = "dodge", colour = "black", size = 0.2, alpha = .6) +
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), 
                position = position_dodge(0.9), width = 0.2) +
  geom_jitter(data = d_independence, aes(x = claim_type, y = update, colour = consensus), 
              position = position_jitterdodge(), alpha = 0.2) +
  ylim(-50, 100) +
  labs(title = "",
       x = "Claim Type",
       y = "Mean Update (Post - Prior)") +
  theme_classic()

```

### Contested v Independent Consensus

```{r}
mean_updates_co <- d_consensus_only %>%
  group_by(claim_type, consensus) %>%
  summarise(mean_update = mean(update),
    se_update = sd(update) / sqrt(n()),
    post = mean(post)
)

mean_updates_co %>% 
  ggplot(aes(x = claim_type, y = mean_update, fill = consensus)) + 
  geom_col(position = "dodge", colour = "black", size = 0.2, alpha = .6) +
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), 
                position = position_dodge(0.9), width = 0.2) +
  geom_jitter(data = d_consensus_only, aes(x = claim_type, y = update, colour = consensus), 
              position = position_jitterdodge(), alpha = 0.2) +
  ylim(-50, 100) +
  labs(title = "",
       x = "Claim Type",
       y = "Mean Update (Post - Prior)") +
  theme_classic()
```

# What are the average deltas (independent - dependent) for each claim type?

```{r}
deltas_claim_type <- d_independence %>% 
  filter(consensus != "contested") %>%
  pivot_wider(names_from = consensus, values_from = update) %>%
  group_by(claim_type) %>%
  summarise(delta = mean(independent, na.rm = TRUE)-mean(dependent, na.rm = TRUE), post = mean(post))

deltas_claim_type %>% 
  ggplot(aes(x = claim_type, y = delta))+
  geom_col(fill = "seagreen")+
  theme_classic()+
  labs(x = "Claim Type", y = "Delta (Independent - Dependent)")
```

# Modelling

```{r}
# load output 
load(here("data/derived/group_output_combined.Rdata"))

```

## Model Comparison

### Excluding contested condition (independent v dependent)

```{r}
model_LOOICs %>%
  filter(excluded_condition == "contested") %>%
  mutate(model_rank = rank(all_looic))
```

### Excluding dependent condition (independent v contested)

```{r}
model_LOOICs %>%
  filter(excluded_condition == "dependent") %>%
  mutate(model_rank = rank(all_looic)) 
```

## Estimates

### Excluding contested condition (independent v dependent)

```{r}
load(here("analyses/02_output/group-prior-consensusXclaim-rm-contested.Rdata"))

getCredibleInt <- function(output, probs = c(0.055, 0.945), decimals = 3){ # default is 89% credible interval 
  posterior_sample <- as_draws_df(output)
  # only include fixed effects
  posterior_sample <- posterior_sample %>%
    select(starts_with("b_"))
  interval <- t(round(apply(posterior_sample, 2, function(x) quantile(x, probs = probs)),3))
  colnames(interval) = c("Lower-CI", "Upper-CI")
  interval
}


getParamDetails <- function(output){
  intervals_89 <- getCredibleInt(output)
  sum_output <- summary(output)
  details <- cbind(round(sum_output$fixed[,"Estimate"],3), intervals_89)
  colnames(details) <- c("Estimate", "Lower", "Upper")
  details
}

getParamDetails(output)

```

### Excluding dependent condition (independent v contested)

```{r}
load(here("analyses/02_output/group-prior-consensusXclaim-rm-dependent.Rdata"))
getParamDetails(output)
```

Initial thoughts. No group level effects of independence when looking at the estimate, but according to model comparison it's still better than the null. No independence X claim type interaction despite hinting showing possible signs in the figures.

Looks like there's an interaction between claim type X consensus, such that people are more convinced by a consensus generally under certain kinds of claims.
