---
title: "Exploratory Analyses"
author: "Ee Von Soh" 
output: html_document
date: "2024-01-16"
---

```{r setup, include = FALSE}
# Load Libraries
library(here)
library(tidyverse)
library(dplyr)

# load data
load(here("data/clean/all_data_clean.Rdata"))

# All data
data <- all_data[[1]] %>%
  mutate(update = post_adjusted - pre_adjusted) # mutate() - create new column(s) that are functions of existing variables

# Only data for dependent and independent condition
d_independence <- data %>% 
  filter(consensus != "contested")

# Only data for independent and contested condition
d_consensus_only <- data %>% 
  filter(consensus != "dependent")

```

## What are the average belief updates for each source type

### Independent V Dependent Consensus
```{r, message = FALSE}
mean_updates <- d_independence %>%
  group_by(source, consensus) %>%
  summarise(mean_update = mean(update),
            se_update = sd(update) / sqrt(n())
  )

mean_updates_w_claim_type <- d_independence %>%
  group_by(source, consensus, claim_type) %>%
  summarise(mean_update = mean(update),
            se_update = sd(update) / sqrt(n())
  )
```

#### Grouped Bar Plot
```{r}
plot1 <- ggplot(mean_updates, aes(x = source, y = mean_update, fill = consensus)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", alpha = 0.6,    width = 0.7) +
  geom_jitter(data = d_independence, aes(x = source, y = update, colour = consensus), position = position_jitterdodge(), alpha = 0.2) + 
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), position = position_dodge(0.7), width = 0.2) + 
  labs(title = "", x = "Source", y = "Mean Update (Post - Prior)") +
  theme_minimal()

plot1
```


```{r, echo = FALSE, fig.show = 'hide'}
# Horizontal bar plot (for own reference)
# Not displayed in html 
plot1 + coord_flip()
```

#### Adding an additional variable (claim type) using facet wrap
```{r}
# Create a new ggplot with facet_wrap
plot2 <- ggplot(mean_updates_w_claim_type, aes(x = source, y = mean_update, fill = consensus)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", alpha = 0.6, width = 0.7) +
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), position = position_dodge(0.7), width = 0.2) + 
  facet_wrap(~claim_type) +  # Facet by claim_type
  labs(title = "", x = "Source", y = "Mean Update (Post - Prior)") +
  theme_minimal()

plot2
```


#### Box Plot
```{r}
plot3 <- ggplot(d_independence, aes(x = source, y = update, fill = consensus)) +
  geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.5) +
  labs(title = "", x = "Source", y = "Update (Post - Prior)", fill = "Consensus") +
  theme_minimal()

plot3
```

### Contested V Dependent Consensus
```{r, message = FALSE}
mean_updates_co <- d_consensus_only %>%
  group_by(source, consensus) %>%
  summarise(mean_update = mean(update),
    se_update = sd(update) / sqrt(n())
)

mean_updates_co_w_claim_type <- d_consensus_only %>%
  group_by(source, consensus, claim_type) %>%
  summarise(mean_update = mean(update),
    se_update = sd(update) / sqrt(n())
)
```

#### Grouped Bar Plot
```{r}
plot4 <- ggplot(mean_updates_co, aes(x = source, y = mean_update, fill = consensus)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", alpha = 0.6,    width = 0.7) +
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), position = position_dodge(0.7), width = 0.2) + 
  labs(title = "", x = "Source", y = "Mean Update (Post - Prior)") +
  theme_minimal()

plot4
```

#### Adding an additional variable using facet wrap (testing)
```{r}
# Create a new ggplot with facet_wrap
plot5 <- ggplot(mean_updates_co_w_claim_type, aes(x = source, y = mean_update, fill = consensus)) +
  geom_bar(position = "dodge", stat = "identity", color = "black", alpha = 0.6, width = 0.7) +
  geom_errorbar(aes(ymin = mean_update - se_update, ymax = mean_update + se_update), position = position_dodge(0.7), width = 0.2) + 
  facet_wrap(~claim_type) +  # Facet by claim_type
  labs(title = "", x = "Source", y = "Mean Update (Post - Prior)") +
  theme_minimal()

plot5
```

#### Box Plot
```{r}
plot6 <- ggplot(d_independence, aes(x = source, y = update, fill = consensus)) +
  geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.5) +
  labs(title = "", x = "Source", y = "Update (Post - Prior)", fill = "Consensus") +
  theme_minimal()

plot6

```


## Exploratory Data Analysis for Demographics
```{r, include = FALSE}
demographics <- all_data$demographics
```

### Age 
#### Statistics
```{r}
# Since Age is a Character, convert it to a numeric
demographics$demographics_age <- as.integer(demographics$demographics_age)

# Mean age
age_stats <- demographics |> 
  summarize(mean_age = mean(demographics_age))
```

#### Histogram - visualise age distribution
```{r}
ggplot(demographics, aes(x = demographics_age)) +  
  geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
  geom_vline(aes(xintercept = mean_age), age_stats, color = "red", linewidth = 1) +   # Geom_vline -> visualise the mean
  labs(title = "Age Distribution", x = "Age", y = "Frequency") +
  theme_minimal()
```

#### Probability Density Function
```{r}
ggplot(demographics, aes(x = demographics_age, y = ..density..)) +  
  # ..density.. -> sets the y axis to represent the density rather than counts.
  geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
  geom_vline(aes(xintercept = mean_age), age_stats, color = "red", linewidth = 1) +
  geom_density(color = "green", linewidth = 2) +
  labs(title = "Age Distribution", x = "Age", y = "Frequency") +
  theme_minimal()
```

Skewed Distribution. Probably because the max age is 72.

### Gender
```{r}
# Frequency table for gender
gender_counts <- table(demographics$demographics_gender) 

# Convert the table to a data frame
gender_counts_df <- as.data.frame(gender_counts)

# Rename the variables in the data frame
colnames(gender_counts_df) <- c("Gender", "Count")

# Calculate percentage
gender_counts_df$Percentage <- gender_counts_df$Count / sum(gender_counts_df$Count) * 100

# Sort the data frame by percentage in descending order
gender_counts_df <- gender_counts_df[order(-gender_counts_df$Percentage), ]

# Keep only the top 2 rows
gender_counts_top2 <- head(gender_counts_df, 2)

# Create a pie chart with labels for the top 2 highest percentages
ggplot(gender_counts_df, aes(x = "", y = Count, fill = Gender)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y") +
  geom_text(data = gender_counts_top2,
            aes(label = paste0(round(Percentage, 1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white",
            size = 4) +
  labs(title = "Gender Distribution", fill = "Gender") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5))
```


### Education
```{r}
table_education <- table(demographics$demographics_education)

# Convert the table to a data frame
df_education <- as.data.frame(table_education)

# Rename the variables in the data frame
colnames(df_education) <- c("Education", "Count")

# Create a bar plot
ggplot(df_education, aes(x = Education, y = Count, fill = Education)) +
  geom_bar(stat = "identity", color = "black", alpha = 0.6) +
  labs(title = "Education Distribution", x = "Education Level", y = "Frequency") +
  theme_minimal()
```

### Social Media Usage 
```{r}
social_media_df <- demographics %>% select(demographics_facebook, demographics_twitter)

barplot(table(demographics$demographics_facebook, demographics$demographics_twitter), 
        beside = TRUE, main = "Social Media Usage", legend = c("Facebook", "Twitter"))
```


## Merge Data with Demographics Information
```{r}
merge_data_dem <- merge(data, demographics, by = c("participant"))
```

```{r, message = FALSE}
merge_data_dem %>%
  group_by(consensus, demographics_education) %>%
  summarise(mean_update = mean(update))
```
### Functions for Plotting
```{r}
# Define a function for plotting a basic grouped bar plot with optional ordering
plot_grouped_bar <- function(by_variable, column, x_label, usage_ordering = NULL, label_angle = 0) {
  
  if (!is.null(usage_ordering)) {
    plot <- ggplot(data = by_variable, aes(x = factor({{column}}, levels = usage_ordering), y = mean_update, fill = consensus)) +
      geom_bar(position = "dodge", stat = "identity", color = "black") + 
      labs(x = x_label, y = "Mean Update (Post - Prior)") + 
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = label_angle, hjust = 1))
  } else {
    plot <- ggplot(data = by_variable, aes(x = {{column}}, y = mean_update, fill = consensus)) +
      geom_bar(position = "dodge", stat = "identity", color = "black") + 
      labs(x = x_label, y = "Mean Update (Post - Prior)") + 
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = label_angle, hjust = 1))
  }
  
  return(plot)
}
```

```{r}
# Add labels to plot
add_num_obs <- function(data, aggregate_data, plot, column, col_name, usage_ordering = NULL, vjust = -1){
  
  count_num_participants <- data %>%
    group_by({{column}}) %>%
    summarise(n_participants = n()/60)
  
  # Merge the count data back into the by_social_media data frame
  by_data_w_count <- merge(aggregate_data, count_num_participants, by = col_name, all.x = TRUE)
  
  if (!is.null(usage_ordering)){
    new_plot <- plot + geom_text(data = by_data_w_count, 
            aes(x = factor({{column}}, levels = usage_ordering), y = 0, label = n_participants), position = position_dodge(1), vjust = vjust, inherit.aes = FALSE)
  }else{
    new_plot <- plot + geom_text(data = by_data_w_count, 
            aes(x = {{column}}, y = 0, label = n_participants), position = position_dodge(1), vjust = vjust, inherit.aes = FALSE)
  }

  return(new_plot)
}
```

```{r}
## Add Jittered Points to Plot
add_jitter <- function(data, plot, width = 0.2, alpha = .1){
  
  new_plot <- plot + geom_jitter(data = data, aes(y = update, colour = consensus), position = position_jitterdodge(dodge.width = width), alpha = alpha) 
  
  return(new_plot)
}
```

### Education
```{r, message = FALSE}
by_education <- merge_data_dem %>%
  group_by(consensus, demographics_education) %>%
  summarise(mean_update = mean(update), n_obs  = n()/60)

by_education
```
#### Grouped Bar Plot with Jitters
```{r}
plot_education <- by_education %>%
  ggplot(aes(x = demographics_education, y = mean_update)) +
  geom_col(position = "dodge", aes(fill = consensus), colour = "black") +
  geom_jitter(data = merge_data_dem, aes(y = update, colour = consensus), position = position_jitterdodge(dodge.width = 1), alpha = .1) +
  labs(title = " ", x = "Education", y = "Mean Update (Post - Prior)") +
  theme_bw()

plot_education
```

#### With Label
```{r}
plot_education_with_num_obs <- add_num_obs(merge_data_dem, by_education, plot_education, demographics_education, "demographics_education", vjust = -6)

plot_education_with_num_obs
```

### Social Media Usage
```{r}
# Constant
USAGE_ORDERING <- c("daily", "weekly", "monthly", "rarely", "never")
```

#### Facebook
```{r, message = FALSE, include = FALSE}
# Ignore this
by_facebook <- merge_data_dem %>%
  group_by(consensus, demographics_facebook) %>%
  summarise(mean_update = mean(update))

by_facebook
```

```{r, message = FALSE, include = FALSE}
# Ignore this
count_facebook_usage <- merge_data_dem %>%
  group_by(demographics_facebook) %>%
  summarise(n_participants = n()/60)

count_facebook_usage
```

```{r, message = FALSE, include = FALSE}
# Ignore this

# Merge the count data back into the by_facebook data frame
by_facebook_merge <- merge(by_facebook, count_facebook_usage, by = "demographics_facebook", all.x = TRUE)

by_facebook_merge
```

```{r, include = FALSE}
# Ignore this
plotA <- ggplot(data = by_facebook, aes(x = factor(demographics_facebook, levels = USAGE_ORDERING), y = mean_update, fill = consensus)) +
  geom_bar(position = "dodge", stat = "identity", color = "black") + 
  labs(x = "Facebook Usage", y = "Mean Update (Post - Prior)") + 
  theme_minimal()

plotA
```

```{r, include = FALSE}
# Ignore this
plotA + geom_text(data = by_facebook_merge, 
            aes(x = factor(demographics_facebook, levels = USAGE_ORDERING), y = 0, label = n_participants),
            position = position_dodge(1), vjust = -22, inherit.aes = FALSE)
```

```{r, include = FALSE}
# Ignore this
plotA + geom_jitter(data = merge_data_dem, aes(y = update, colour = consensus), position = position_jitterdodge(dodge.width = 0.2), alpha = .1) 
```

##### Basic Grouped Bar Plot
```{r, message = FALSE}
by_facebook <- merge_data_dem %>%
  group_by(consensus, demographics_facebook) %>%
  summarise(mean_update = mean(update))

plot_facebook <- plot_grouped_bar(by_facebook, demographics_facebook, x_label = "Facebook Usage", usage_ordering = USAGE_ORDERING)

plot_facebook

```

##### With Labels for total observations
```{r}
plot_facebook_with_num_obs <- add_num_obs(merge_data_dem, by_facebook, plot_facebook, demographics_facebook, col_name = "demographics_facebook", usage_ordering = USAGE_ORDERING, vjust = -22)

plot_facebook_with_num_obs
```

##### With Jittered Points
```{r}
plot_facebook_with_jitter <- add_jitter(merge_data_dem, plot_facebook)

plot_facebook_with_jitter
```

#### Twitter
##### Basic Grouped Bar Plot
```{r, message = FALSE}
by_twitter <- merge_data_dem %>%
  group_by(consensus, demographics_twitter) %>%
  summarise(mean_update = mean(update))

plot_twitter <- plot_grouped_bar(by_twitter, demographics_twitter, x_label = "Twitter Usage", usage_ordering = USAGE_ORDERING)

plot_twitter

```

##### With Labels 
```{r}
plot_twitter_with_num_obs <- add_num_obs(merge_data_dem, by_twitter, plot_twitter, demographics_twitter, "demographics_twitter", usage_ordering =  USAGE_ORDERING, vjust = -22)

plot_twitter_with_num_obs
```

##### With Jittered Points
```{r}
plot_twitter_with_jitter <- add_jitter(merge_data_dem, plot_twitter)

plot_twitter_with_jitter
```

### Politics
#### Basic Grouped Bar Plot
```{r, message = FALSE}
by_politics <- merge_data_dem %>%
  group_by(consensus, demographics_politics) %>%
  summarise(mean_update = mean(update))

plot_politics <- plot_grouped_bar(by_politics, demographics_politics, x_label = "Politics", label_angle = 45)

plot_politics
```

#### With Labels
```{r}
plot_politics_with_num_obs <- add_num_obs(merge_data_dem, by_politics, plot_politics, demographics_politics, "demographics_politics", vjust = -16.5)

plot_politics_with_num_obs
```

#### With Jittered Points
```{r}
plot_politics_with_jitter <- add_jitter(merge_data_dem, plot_politics, width = 0.2, alpha = 0.07)

plot_politics_with_jitter
```

### What are the Average Deltas (independent - dependent) for each claim type
```{r}
deltas_claim_type <- merge_data_dem %>% 
  filter(consensus != "contested") %>%
  pivot_wider(names_from = consensus, values_from = update) %>%
  group_by(participant) %>%
  summarise(delta = mean(independent, na.rm = TRUE)-mean(dependent, na.rm = TRUE), age = mean(demographics_age))
  
plot(deltas_claim_type$delta, deltas_claim_type$age)
cor(deltas_claim_type$delta, deltas_claim_type$age)

```







